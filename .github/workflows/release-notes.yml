name: Weekly Release Notes

on:
  schedule:
    # Every Thursday at 09:00 UTC
    - cron: "0 9 * * 4"
  workflow_dispatch:
    inputs:
      from:
        description: "Start date (YYYY-MM-DD). Defaults to previous Thursday."
        required: false
      to:
        description: "End date (YYYY-MM-DD). Defaults to today."
        required: false

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Compute date range
        id: dates
        run: |
          if [ -n "${{ github.event.inputs.from }}" ]; then
            FROM="${{ github.event.inputs.from }}"
          else
            # Previous Thursday (7 days ago)
            FROM=$(date -u -d "7 days ago" +%Y-%m-%d 2>/dev/null || date -u -v-7d +%Y-%m-%d)
          fi

          if [ -n "${{ github.event.inputs.to }}" ]; then
            TO="${{ github.event.inputs.to }}"
          else
            TO=$(date -u +%Y-%m-%d)
          fi

          echo "from=$FROM" >> "$GITHUB_OUTPUT"
          echo "to=$TO" >> "$GITHUB_OUTPUT"
          echo "filename=release-notes/${TO}.md" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          mkdir -p release-notes
          node dist/cli.js \
            --owner "${{ github.repository_owner }}" \
            --repo "${{ github.event.repository.name }}" \
            --from "${{ steps.dates.outputs.from }}" \
            --to "${{ steps.dates.outputs.to }}" \
            --github-token "$GH_TOKEN" \
            --output "${{ steps.dates.outputs.filename }}"

      - name: Commit and push release notes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add release-notes/
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: add release notes for ${{ steps.dates.outputs.from }} â†’ ${{ steps.dates.outputs.to }}"
          git push
